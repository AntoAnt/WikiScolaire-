package com.ecetech.b3.itproject;

import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;

import javax.servlet.ServletConfig;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.ecetech.b3.itproject.redline.beans.compte;
import com.ecetech.b3.itproject.redline.beans.cours;
import com.ecetech.b3.itproject.redline.beans.user;
import com.ecetech.b3.itproject.redline.dao.coursDAO;
import com.ecetech.b3.itproject.redline.dao.userDAO;

/**
 * Servlet implementation class ControleurPrincipal
 */

public class ControleurPrincipal extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public ControleurPrincipal() {
        super();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see Servlet#init(ServletConfig)
	 */
	public void init(ServletConfig config) throws ServletException {
		// TODO Auto-generated method stub
		super.init(config);
	}

	/**
	 * @see Servlet#destroy()
	 */
	public void destroy() {
		// TODO Auto-generated method stub
	}

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		String idaction = request.getParameter("idaction");
		
		if(idaction==null){
			System.out.println("erreur idaction non trouvé");
			this.getServletContext().getRequestDispatcher("/InterfaceWikiScolair/Index.html").forward( request, response );
		}
		else if(idaction.equals("authentification")){
			String login = request.getParameter("CHAMP_login");
			String psw = request.getParameter("CHAMP_mdp");
			user u = null;
			//String psw = cripterPswAlgoInit(request.getParameter("CHAMP_mdp"));
			try {
				//user u = userDAO.getuserLoginPsw(login,psw);
				u = userDAO.getuserbylogin(login);
				if(u == null){
					// forward vers la page jsp d'erreur d'authentification ; user login inexistant
					System.out.println("erreur user null");
				}
				else if(!(u.getMdp().equals(psw))){
					// forward vers la âge jsp d'erreur d'authentification ; user psw erroné
				}
				else if(u.getMdp().equals(psw)){
					System.out.println("Ok Creation de la session");
					// création d'une session utilisateur ...
					HttpSession session = request.getSession();
					session.setAttribute( "login", u.getLogin() );
					session.setAttribute("id", u.getId_user());
					// forward vers la page d'acceuil après authentification
					this.getServletContext().getRequestDispatcher("/WEB-INF/accueil.jsp").forward( request, response );
				}
				
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
				//tester sur l'exception et selon le code -> retourner une url : 505... 404...
			}
			
		}
		/* When the creation of a new user is requested*/
		else if(idaction.equals("Inscription")){
			//String id = request.getParameter("CHAMP_id"); to generate UUID
			String id_user = "";
			String login = request.getParameter("CHAMP_Login");			
			String psw = request.getParameter("CHAMP_Mdp");
			String niveau =request.getParameter("CHAMP_Niv");
			String id_compte = "";
			String Nom =request.getParameter("CHAMP_Nom");
			String Prenom =request.getParameter("CHAMP_Prenom");
			String Email =request.getParameter("CHAMP_Email");
			String Telephone =request.getParameter("CHAMP_Tel");
			String Codepostal =request.getParameter("CHAMP_CP");
			

			user u = new user(id_user, login, psw, niveau);
			compte c = new compte(id_compte, id_user, Nom, Prenom, Email, Codepostal, Telephone);
			try {
				if(login == null){
					// forward vers la page jsp d'erreur d'Inscription ; user login non renseigner
				}
				else if(psw == null){
					// forward vers la page jsp d'erreur d'Inscription ; user psw non renseigner
				}
				else if(niveau == null){
					// forward vers la page jsp d'erreur d'Inscription ; user Niveau non renseigner
				}
				else if(Nom == null){
					// forward vers la page jsp d'erreur d'Inscription ; user Nom non renseigner
				}
				else if(Prenom == null){
					// forward vers la page jsp d'erreur d'Inscription ; user Prenom non renseigner
				}
				else if(Email == null){
					// forward vers la page jsp d'erreur d'Inscription ; user Email non renseigner
				}
				else if(Codepostal == null){
					// forward vers la page jsp d'erreur d'Inscription ; user CP non renseigner
				}
				else if (Telephone == null){
					// forward vers la page jsp d'erreur d'Inscription ; user Tel non renseigner
				}
				int codeop = userDAO.insertUser(u);
				
				//selon le code ... retourner le résultat de l'opération ... utilisateur ajouté avec succès;
				System.out.print(codeop + "est la valeur du bidule\n");
				
			} catch (SQLException e) {
				// TODO Auto-generated catch block
				e.printStackTrace();
				//tester sur l'exception et selon le code -> retourner une url : 505... 404...
			}
			
		}
		else if(idaction.equals("coursesList"))
		{
			HttpSession session = request.getSession();
			if( session.getAttribute("login") != null )
			{
				this.getServletContext().getRequestDispatcher("/WEB-INF/Connexion.jsp").forward( request, response );
			}
			else
			{
				ArrayList<cours> resultat = null;
				try {
					resultat = coursDAO.getAllCours();
					//on affiche le nombre de cours dans l'arraylist
					System.out.println(resultat.size()+" est le nombre de cours");
					// on redirige vers là page de la liste des cours
					
					this.getServletContext().getRequestDispatcher("/WEB-INF/coursAll.jsp").forward( request, response );
					
				} catch (SQLException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
					//tester sur l'exception et selon le code -> retourner une url : 505... 404...
				}
			}
		}
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		doGet(request, response);
	}

}
